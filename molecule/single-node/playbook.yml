---
- hosts: all
  gather_facts: 'no'
  tasks:
    - name: Install python for Ansible
      raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)
      become: 'yes'
      changed_when: false

- hosts: all
  become: true
  pre_tasks:
    - name: Install required EPEL access for redis packages on CentOS / RedHat.
      yum:
        name: epel-release
    # Required to initialise the cluster - redis-trib is a ruby app
    - name: Install ruby
      package:
        name: ruby
    - name: Install net-tools for testinfra socket testing.
      package:
        name: net-tools

  roles:
    - { role: redis/core, redis_data_dir: "/opt/data/redis", redis_log_dir: "/opt/log/redis", redis_run_dir: "/opt/run/redis" }
    - { role: redis/node, redis_port: 7000, redis_data_dir: "/opt/data/redis", redis_log_dir: "/opt/log/redis", redis_run_dir: "/opt/run/redis" }
    - { role: redis/node, redis_port: 7001, redis_data_dir: "/opt/data/redis", redis_log_dir: "/opt/log/redis", redis_run_dir: "/opt/run/redis" }
    - { role: redis/node, redis_port: 7002, redis_data_dir: "/opt/data/redis", redis_log_dir: "/opt/log/redis", redis_run_dir: "/opt/run/redis" }
    - { role: redis/cluster, redis_cluster_replicas: 0, redis_node_list: "{{ groups['all'] | map('extract', hostvars, ['ansible_eth0', 'ipv4', 'address']) | arraypermute( [':'] ) | arraypermute( [7000,7001,7002] ) }}" }

# redis_data_dir: "/opt/data/redis", redis_log_dir: "/opt/log/redis", redis_run_dir: "/opt/run/redis" }
